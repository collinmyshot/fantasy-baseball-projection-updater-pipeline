name: Daily Fangraphs Refresh

on:
  workflow_dispatch:
  schedule:
    # Standard Time months (PT = UTC-8): Jan, Feb, Dec.
    - cron: '0 11 * 1,2,12 *'
    # Daylight Time months (PT = UTC-7): Apr-Oct.
    - cron: '0 10 * 4-10 *'
    # March transition handling:
    # Mar 1-7 is always standard time, Mar 15-31 is always daylight time,
    # and Mar 8-14 can contain the DST flip depending on year.
    - cron: '0 11 1-7 3 *'
    - cron: '0 10 15-31 3 *'
    - cron: '0 10 8-14 3 *'
    - cron: '0 11 8-14 3 *'
    # November transition handling:
    # Nov 8-30 is always standard time, and Nov 1-7 can contain the DST flip.
    - cron: '0 10 1-7 11 *'
    - cron: '0 11 1-7 11 *'
    - cron: '0 11 8-30 11 *'

permissions:
  contents: write

concurrency:
  group: daily-fangraphs-refresh
  cancel-in-progress: false

jobs:
  refresh:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Gate schedule to 3:00 AM Pacific
        id: gate
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "run_pipeline=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          PT_HOUR=$(TZ=America/Los_Angeles date +%H)
          PT_MIN=$(TZ=America/Los_Angeles date +%M)
          if [ "$PT_HOUR" = "03" ] && [ "$PT_MIN" = "00" ]; then
            echo "run_pipeline=true" >> "$GITHUB_OUTPUT"
          else
            echo "run_pipeline=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup R
        if: steps.gate.outputs.run_pipeline == 'true'
        uses: r-lib/actions/setup-r@v2

      - name: Install R deps
        if: steps.gate.outputs.run_pipeline == 'true'
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          packages: |
            any::shiny
            any::DT
            any::bslib
            any::jsonlite
            any::yaml
            any::googlesheets4
            any::rsconnect

      - name: Write Google service account key
        if: steps.gate.outputs.run_pipeline == 'true'
        env:
          GSHEETS_SERVICE_ACCOUNT_JSON: ${{ secrets.GSHEETS_SERVICE_ACCOUNT_JSON }}
        run: |
          if [ -z "$GSHEETS_SERVICE_ACCOUNT_JSON" ]; then
            echo "Missing required secret: GSHEETS_SERVICE_ACCOUNT_JSON" >&2
            exit 1
          fi
          KEY_FILE="$RUNNER_TEMP/gsheets-service-account.json"
          printf '%s' "$GSHEETS_SERVICE_ACCOUNT_JSON" > "$KEY_FILE"
          echo "GSHEETS_SERVICE_ACCOUNT_FILE=$KEY_FILE" >> "$GITHUB_ENV"

      - name: Run full pipeline
        if: steps.gate.outputs.run_pipeline == 'true'
        run: Rscript scripts/run_pipeline.R --config config/pipeline.yml

      - name: Commit refreshed data
        if: steps.gate.outputs.run_pipeline == 'true'
        run: |
          if [ -z "$(git status --porcelain data)" ]; then
            echo "No data changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data
          git commit -m "chore: refresh fangraphs projections"
          git push

      - name: Deploy Shiny app
        if: steps.gate.outputs.run_pipeline == 'true'
        env:
          SHINYAPPS_ACCOUNT: ${{ secrets.SHINYAPPS_ACCOUNT }}
          SHINYAPPS_TOKEN: ${{ secrets.SHINYAPPS_TOKEN }}
          SHINYAPPS_SECRET: ${{ secrets.SHINYAPPS_SECRET }}
          SHINYAPP_NAME: ${{ secrets.SHINYAPPS_APP_NAME }}
        run: |
          if [ -z "$SHINYAPPS_ACCOUNT" ] || [ -z "$SHINYAPPS_TOKEN" ] || [ -z "$SHINYAPPS_SECRET" ]; then
            echo "Missing required shinyapps secrets: SHINYAPPS_ACCOUNT, SHINYAPPS_TOKEN, SHINYAPPS_SECRET" >&2
            exit 1
          fi
          APP_NAME="${SHINYAPP_NAME:-fantasy-baseball-projection-updater}"
          Rscript scripts/deploy_shinyapps.R . "$APP_NAME"
