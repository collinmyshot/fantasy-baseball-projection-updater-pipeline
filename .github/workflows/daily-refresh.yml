name: Daily Fangraphs Refresh

on:
  workflow_dispatch:
  schedule:
    - cron: '7 15 * * *'
    - cron: '7 16 * * *'

permissions:
  contents: write

concurrency:
  group: daily-fangraphs-refresh
  cancel-in-progress: false

jobs:
  refresh:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Gate schedule to 8:07 AM Pacific
        id: gate
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "run_pipeline=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          PT_HOUR=$(TZ=America/Los_Angeles date +%H)
          if [ "$PT_HOUR" = "08" ]; then
            echo "run_pipeline=true" >> "$GITHUB_OUTPUT"
          else
            echo "run_pipeline=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup R
        if: steps.gate.outputs.run_pipeline == 'true'
        uses: r-lib/actions/setup-r@v2

      - name: Install R deps
        if: steps.gate.outputs.run_pipeline == 'true'
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          packages: |
            any::jsonlite
            any::yaml
            any::googlesheets4

      - name: Write Google service account key
        if: steps.gate.outputs.run_pipeline == 'true'
        env:
          GSHEETS_SERVICE_ACCOUNT_JSON: ${{ secrets.GSHEETS_SERVICE_ACCOUNT_JSON }}
        run: |
          if [ -z "$GSHEETS_SERVICE_ACCOUNT_JSON" ]; then
            echo "Missing required secret: GSHEETS_SERVICE_ACCOUNT_JSON" >&2
            exit 1
          fi
          KEY_FILE="$RUNNER_TEMP/gsheets-service-account.json"
          printf '%s' "$GSHEETS_SERVICE_ACCOUNT_JSON" > "$KEY_FILE"
          echo "GSHEETS_SERVICE_ACCOUNT_FILE=$KEY_FILE" >> "$GITHUB_ENV"

      - name: Run full pipeline
        if: steps.gate.outputs.run_pipeline == 'true'
        run: Rscript scripts/run_pipeline.R --config config/pipeline.yml

      - name: Commit refreshed data
        if: steps.gate.outputs.run_pipeline == 'true'
        run: |
          if [ -z "$(git status --porcelain data)" ]; then
            echo "No data changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data
          git commit -m "chore: refresh fangraphs projections"
          git push
